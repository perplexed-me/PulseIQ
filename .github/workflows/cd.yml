# ── Deploy on Azure VM ─────────────────────────────────────────
- name: Deploy on Azure VM
  uses: appleboy/ssh-action@v1
  with:
    host:     ${{ secrets.AZURE_SSH_HOST }}
    username: ${{ secrets.AZURE_SSH_USER }}
    key:      ${{ secrets.AZURE_SSH_PRIVATE_KEY }}
    envs:
      - FIREBASE_JSON
      - SPRING_DATASOURCE_URL
      - SPRING_DATASOURCE_USERNAME
      - SPRING_DATASOURCE_PASSWORD
      - JWT_SECRET
      - APP_CORS_ALLOWED_ORIGINS
  script: |
    set -e

    echo "=== Pull latest image ==="
    docker pull ${{ secrets.DOCKER_USERNAME }}/pulseiq-app:latest

    echo "=== Remove old backend container ==="
    docker rm -f pulseiq_backend 2>/dev/null || true

    echo "=== Start new backend container ==="
    docker run -d --name pulseiq_backend \
      -p 8085:8085 \
      -e FIREBASE_JSON="$FIREBASE_JSON" \
      -e SPRING_DATASOURCE_URL="$SPRING_DATASOURCE_URL" \
      -e SPRING_DATASOURCE_USERNAME="$SPRING_DATASOURCE_USERNAME" \
      -e SPRING_DATASOURCE_PASSWORD="$SPRING_DATASOURCE_PASSWORD" \
      -e JWT_SECRET="$JWT_SECRET" \
      -e APP_CORS_ALLOWED_ORIGINS="$APP_CORS_ALLOWED_ORIGINS" \
      ${{ secrets.DOCKER_USERNAME }}/pulseiq-app:latest
